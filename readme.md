# 🎯 Confluence 页面克隆与正则同步工具

这是一个基于 **Streamlit** 开发的高级 Confluence 迁移工具。它允许你跨空间或在同空间内精确挑选页面，并支持在迁移过程中通过**正则表达式**重命名标题及修改正文。

## 🚀 核心特性

- **灵活挑选**：动态加载目录树，支持勾选任意层级页面。
- **正则替换**：支持 Python 标准正则（Regex），可通过 `$1`, `$2` 捕获组实现复杂的命名逻辑（如：`{title}` → `{$1}-v2`）。
- **权限同步**：跨空间迁移时，程序会尝试镜像源页面的阅读与编辑权限（基于 AccountID）。
- **结构保持**：智能识别父子关系。若勾选了父子页面，自动保持原有树状结构；若只选子页面，则自动上浮挂载。
- **UI 等价复制**：同空间内采用官方 Copy API，完美保留页面附件、宏、以及网页端“复制”的所有属性。**跨空间无法保留权限建议同空间复制后手动迁移。**

## 🛠️ 环境准备

1. **安装 Python 3.10+**

2. **安装依赖库**：

   ```
   pip install streamlit requests streamlit-tree-select
   ```

3. **获取 API Token**：

   - 登录 Atlassian 账户，前往 [API Tokens 页面](https://id.atlassian.com/manage-profile/security/api-tokens)。
   - 创建并保存 Token。

## 📖 使用指南

### 1. 启动工具

在项目根目录下执行：

```
streamlit run app.py
```

### 2. 配置参数

- **认证配置**：输入你的 Atlassian 注册邮箱和 API Token。
- **空间配置**：
  - **源端**：填入空间 Key。若需限制范围，可填入起始页面 ID。
  - **目标端**：填入目标空间 Key 和挂载点的页面 ID。
- **正则替换（可选）**：
  - **模式 (Pattern)**：例如 `(.*)` 匹配全部。
  - **替换 (Replacement)**：例如 `$1-归档`。

### 3. 执行克隆

1. 点击 **“第一步：加载页面树”**。
2. 在展开的目录树中勾选需要同步的页面。
3. 点击 **“开始同步”**。

------

## 🧪 正则表达式示例

| **需求场景**     | **匹配模式 (Pattern)** | **替换内容 (Replacement)** | **结果示例**                    |
| ---------------- | ---------------------- | -------------------------- | ------------------------------- |
| **整体加后缀**   | `(.*)`                 | `$1-副本`                  | `个人记录` → `个人记录-副本`    |
| **修改年份**     | `2023-(.*)`            | `2024-$1`                  | `2023-月报` → `2024-月报`       |
| **删除特定词汇** | `【草稿】(.*)`         | `$1`                       | `【草稿】需求文档` → `需求文档` |
| **内容调换**     | `(.*?)-(.*)`           | `$2($1)`                   | `张三-日报` → `日报(张三)`      |

------

## 📂 项目结构


```
copyCon/
├── app.py              # Streamlit 交互界面 (含正则处理逻辑)
├── confluence.py       # 核心 API 逻辑 (含权限同步函数)
├── tree.py             # 目录树构建逻辑
└── README.md           # 本说明文档
```

## ⚠️ 重要说明

- **标题重复**：Confluence 同一父页面下不允许有重名页面。如果同步失败，请检查目标位置是否存在同名文件。
- **权限同步限制**：权限同步依赖于目标空间中存在相同的 `AccountID` 或用户组。如果是两个完全独立的 Confluence 实例，权限同步可能失效。
- **管理员权限**：建议使用拥有源空间“读取”和目标空间“管理员”权限的账号操作，以确保权限锁定成功。

## 🌐 局域网访问

若需共享给同事，启动时请指定地址：


```
streamlit run app.py --server.address 0.0.0.0
```

*提示：请确保电脑防火墙已开放 **8501** 端口的入站权限。*
